---
title: "FTS"
author: "Małgorzata Leszczyńska"
date: "2024-05-05"
output: html_document
---
```{r, include = FALSE}
library(tidyverse)
library(dplyr)
library(stats)
library(ggplot2)
library(dplyr)
library(tseries)
library(writexl)
library(tsibble)
library(tsibbledata)
library(feasts)
library(fable)
library(psych)
library(urca)
library(forecast)
library(rugarch)
library(tseries)
```

# Q1 A

This question was answeres directly in the report. The only required code was
to plot the time-series history (a trivial affair).

# Q1 B

Obtain the log returns and plot the time series graph of prices and log returns. Obtain the correlogram and descriptive statistics for prices and log returns. Comment on the distributional and dynamical properties of the data (mean, volatility, skewness, kurtosis, stationarity, outliers,. . .). Which stylized facts about financial returns you observe in the data?

### Importing the data

```{r}
data <- read.csv("data/MSFT - 5 Years.csv", sep = ",", header = TRUE)
data_visa <- read.csv("data/V - 5 Years.csv", sep = ",", header = TRUE)

data_ts <- data %>% mutate(Date = ymd(Date)) %>% as_tsibble(index = Date)
data_ts_visa <- data_visa %>% mutate(Date = ymd(Date)) %>% as_tsibble(index = Date)
```

### Creating simpple return and log return

```{r}
data_ts <- data_ts %>% mutate(simple_rtn = difference(Close)/lag(Close), log_rtn = difference((log(Close))))
data_ts_visa <- data_ts_visa %>% mutate(simple_rtn = difference(Close)/lag(Close), log_rtn = difference((log(Close))))
```

### Plots Microsoft

```{r}
microsoft_prices_plot <- data_ts %>% autoplot(Close) + ylab("Closing price [USD]") + xlab("Date") + theme_bw() + ggtitle("Microsoft price from 2019 to 2024")

ggsave(microsoft_prices_plot, filename = "microsoft_prices.png", device = "png", height = 6, width = 8, units = "in")

microsoft_prices_rtns_plot <- data_ts %>% autoplot(simple_rtn) + ylab("Simple returns [USD]") + xlab("Date") + theme_bw() + ggtitle("Microsoft simple returns from 2019 to 2024")

ggsave(microsoft_prices_rtns_plot, filename = "microsoft_simple_returns.png", device = "png", height = 6, width = 8, units = "in")

microsoft_prices_log_plot <- data_ts %>% autoplot(log_rtn) + ylab("Log return [USD]") + xlab("Date") + theme_bw() + ggtitle("Microsoft log returns from 2019 to 2024")

ggsave(microsoft_prices_log_plot, filename = "microsoft_log_returns.png", device = "png", height = 6, width = 8, units = "in")
```

### Plots Visa

```{r}
visa_prices_plot <- data_ts_visa %>% autoplot(Close) + ylab("Closing price [USD]") + xlab("Date") + theme_bw() + ggtitle("Visa price from 2019 to 2024")

ggsave(visa_prices_plot, filename = "visa_prices.png", device = "png", height = 6, width = 8, units = "in")

visa_prices_rtns_plot <- data_ts_visa %>% autoplot(simple_rtn) + ylab("Simple returns [USD]") + xlab("Date") + theme_bw() + ggtitle("Visa simple returns from 2019 to 2024")

ggsave(visa_prices_rtns_plot, filename = "visa_simple_returns.png", device = "png", height = 6, width = 8, units = "in")

visa_prices_log_plot <- data_ts_visa %>% autoplot(log_rtn) + ylab("Log return [USD]") + xlab("Date") + theme_bw() + ggtitle("Visa log returns from 2019 to 2024")

ggsave(visa_prices_log_plot, filename = "visa_log_returns.png", device = "png", height = 6, width = 8, units = "in")
```

### Collerograms for the close price Microsoft

```{r}
collerograms <- data_ts %>% mutate(trading_day = row_number()) %>% update_tsibble(index = trading_day, regular = TRUE)

png(file="microsoft_acf_plot_prices_1249.png", height = 6, width = 8, res=1080, units = "in") 
microsoft_acf_plot_1249 <- acf(collerograms$Close, lag.max = 1249, main = "ACF for Microsoft, close prices, lag = 1249", xlab = "Lag (#trading days)")
dev.off()

png(file="microsoft_acf_plot_prices_60.png", height = 6, width = 8, res=1080, units = "in") 
microsoft_acf_plot_60 <- acf(collerograms$Close, lag.max = 60, main = "ACF for Microsoft, close prices, lag = 60", xlab = "Lag (#trading days)")
dev.off()

png(file="microsoft_pacf_plot_prices_1249.png", height = 6, width = 8, res=1080, units = "in")
microsoft_pacf_plot_1249 <- pacf(collerograms$Close, lag.max = 1249, main = "PACF for Microsoft, close prices, lag = 1249", xlab = "Lag (#trading days)")
dev.off()

png(file="microsoft_pacf_plot_prices_60.png", height = 6, width = 8, res=1080, units = "in")
microsoft_pacf_plot_60 <- pacf(collerograms$Close, lag.max = 60, main = "PACF for Microsoft, close prices, lag = 60", xlab = "Lag (#trading days)")
dev.off()
```

### Collerograms for the close price Visa

```{r}
collerograms_visa <- data_ts_visa %>% mutate(trading_day = row_number()) %>% update_tsibble(index = trading_day, regular = TRUE)

png(file="visa_acf_plot_prices_1249.png", height = 6, width = 8, res=1080, units = "in") 
visa_acf_plot_1249 <- acf(collerograms_visa$Close, lag.max = 1249, main = "ACF for Visa, close prices, lag = 1249", xlab = "Lag (#trading days)")
dev.off()

png(file="visa_acf_plot_prices_60.png", height = 6, width = 8, res=1080, units = "in") 
visa_acf_plot_60 <- acf(collerograms_visa$Close, lag.max = 60, main = "ACF for Visa, close prices, lag = 60", xlab = "Lag (#trading days)")
dev.off()

png(file="visa_pacf_plot_prices_1249.png", height = 6, width = 8, res=1080, units = "in")
visa_pacf_plot_1249 <- pacf(collerograms_visa$Close, lag.max = 1249, main = "PACF for Visa, close prices, lag = 1249", xlab = "Lag (#trading days)")
dev.off()

png(file="visa_pacf_plot_prices_60.png", height = 6, width = 8, res=1080, units = "in")
visa_pacf_plot_60 <- pacf(collerograms_visa$Close, lag.max = 60, main = "PACF for Visa, close prices, lag = 60", xlab = "Lag (#trading days)")
dev.off()
```

### Collerograms for the log returns price Microsoft

```{r}
collerograms <- data_ts %>% mutate(trading_day = row_number()) %>% update_tsibble(index = trading_day, regular = TRUE)
collerograms <- na.omit(collerograms)

png(file="microsoft_acf_plot_log_return_1249.png", height = 6, width = 8, res=1080, units = "in") 
microsoft_acf_plot_log_return_1249 <- acf(collerograms$log_rtn, lag.max = 1249, main = "ACF for Microsoft, log returns, lag = 1249", xlab = "Lag (#trading days)")
dev.off()

png(file="microsoft_acf_plot_log_return_60.png", height = 6, width = 8, res=1080, units = "in") 
microsoft_acf_plot_log_retrun_60 <- acf(collerograms$log_rtn, lag.max = 60, main = "ACF for Microsoft, log returns, lag = 60", xlab = "Lag (#trading days)")
dev.off()

png(file="microsoft_pacf_plot_log_return_1249.png", height = 6, width = 8, res=1080, units = "in")
microsoft_pacf_plot_log_return_1249 <- pacf(collerograms$log_rtn, lag.max = 1249, main = "PACF for Microsoft, log returns, lag = 1249", xlab = "Lag (#trading days)")
dev.off()

png(file="microsoft_pacf_plot_log_return_60.png", height = 6, width = 8, res=1080, units = "in")
microsoft_pacf_plot_log_return_60 <- pacf(collerograms$log_rtn, lag.max = 60, main = "PACF for Microsoft, log returns, lag = 60", xlab = "Lag (#trading days)")
dev.off()
```

### Collerograms for the log returns price Visa

```{r}
collerograms_visa <- data_ts_visa %>% mutate(trading_day = row_number()) %>% update_tsibble(index = trading_day, regular = TRUE)
collerograms_visa <- na.omit(collerograms_visa)

png(file="visa_acf_plot_log_return_1249.png", height = 6, width = 8, res=1080, units = "in") 
visa_acf_plot_log_return_1249 <- acf(collerograms_visa$log_rtn, lag.max = 1249, main = "ACF for Visa, log returns, lag = 1249", xlab = "Lag (#trading days)")
dev.off()

png(file="visa_acf_plot_log_return_60.png", height = 6, width = 8, res=1080, units = "in") 
visa_acf_plot_log_retrun_60 <- acf(collerograms_visa$log_rtn, lag.max = 60, main = "ACF for Visa, log returns, lag = 60", xlab = "Lag (#trading days)")
dev.off()

png(file="visa_pacf_plot_log_return_1249.png", height = 6, width = 8, res=1080, units = "in")
visa_pacf_plot_log_return_1249 <- pacf(collerograms_visa$log_rtn, lag.max = 1249, main = "PACF for Visa, log returns, lag = 1249", xlab = "Lag (#trading days)")
dev.off()

png(file="visa_pacf_plot_log_return_60.png", height = 6, width = 8, res=1080, units = "in")
visa_pacf_plot_log_return_60 <- pacf(collerograms_visa$log_rtn, lag.max = 60, main = "PACF for Visa, log returns, lag = 60", xlab = "Lag (#trading days)")
dev.off()
```


### Summary Microsoft

```{r, echo=FALSE}
data_df <- data.frame(data_ts)

describe(data_df$Close)
describe(data_df$log_rtn)
```

```{r}
microsoft_frequency_close <- ggplot(data.frame(x = data_df$Close), aes(x = x)) +
  geom_density(fill = "blue", alpha = 0.3) +
  labs(title = "Microsoft Close",
       x = "Close",
       y = "Frequency") +
  theme_minimal()
```

```{r}
microsoft_frequency_log_return <- ggplot(data.frame(x = data_df$log_rtn), aes(x = x)) +
  geom_density(fill = "blue", alpha = 0.3) +
  labs(title = "Microsoft Log return",
       x = "Log return",
       y = "Frequency") +
  theme_minimal()
```


### Summary Visa

```{r, echo=FALSE}
data_df_visa <- data.frame(data_ts_visa)

describe(data_df_visa$Close)
describe(data_df_visa$log_rtn)
```

```{r}
visa_frequency_close <- ggplot(data.frame(x = data_df_visa$Close), aes(x = x)) +
  geom_density(fill = "blue", alpha = 0.3) +
  labs(title = "Visa Close",
       x = "Close",
       y = "Frequency") +
  theme_minimal()
```

```{r}
visa_frequency_log_return <- ggplot(data.frame(x = data_df_visa$log_rtn), aes(x = x)) +
  geom_density(fill = "blue", alpha = 0.3) +
  labs(title = "Visa Log return",
       x = "Log return",
       y = "Frequency") +
  theme_minimal()
```

# Q1 c

Apply the Augmented Dickey-Fuller (ADF) test to the log prices. Describe in detail the conclusions of the test.

### Stationary test ADF Microsoft

**H0**: time series is not stationary

**H1**: time series is stationary

```{r, warning=FALSE}
data_ts <- na.omit(data_ts)

adf.test(data_ts$log_rtn)
```

P-value od the test is below the confidence level alpha=0.05, so we can accept H1. The time series is **stationary**.

### Stationary test ADF Visa

**H0**: time series is not stationary

**H1**: time series is stationary

```{r, warning=FALSE}
data_ts_visa <- na.omit(data_ts_visa)

adf.test(data_ts_visa$log_rtn)
```

P-value od the test is below the confidence level alpha=0.05, so we can accept H1. The time series is **stationary**.

# Q1 d

Perform a simplified Box-Jenkins analysis to find an ARMA model (AR, MA or mixed) that best describes the log returns. Justify your choice.

```{r}
simplified_box_jenkins <- function(log_returns) {
  arma_model <- auto.arima(log_returns)
  print(summary(arma_model))
  
  acf_pacf_plot <- ggtsdisplay(log_returns)
  print(acf_pacf_plot)
  
  return(arma_model)
}

```

### Box Jenkins Microsoft

```{r}
msft_arma_model <- simplified_box_jenkins(data_ts$log_rtn)
```

```{r}
residuals <- residuals(msft_arma_model)

ggplot(data.frame(time = 1:length(residuals), residuals = residuals), aes(x = time, y = residuals)) +
  geom_line(color = "black") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Residuals of the Microsoft Log returns ARIMA model",
       y = "Residuals") +
  theme_minimal()

Box.test(residuals, lag = 10, type = "Ljung-Box")
```

```{r}
ggAcf(residuals, main = "Microsoft ACF of residuals ARIMA(0,0,1)")

ggPacf(residuals, main = "Microsoft PACF of residuals ARIMA(0,0,1)")

```


### Box Jenkins Visa

```{r}
visa_arma_model <- simplified_box_jenkins(data_ts_visa$log_rtn)
```


```{r}
residuals <- residuals(visa_arma_model)

ggplot(data.frame(time = 1:length(residuals), residuals = residuals), aes(x = time, y = residuals)) +
  geom_line(color = "black") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  labs(title = "Residuals of the Visa Log returns ARIMA model",
       y = "Residuals") +
  theme_minimal()

Box.test(residuals, lag = 10, type = "Ljung-Box")
```

```{r}
ggAcf(residuals, main = "Visa ACF of residuals ARIMA(3,0,3)")

ggPacf(residuals, main = "Visa PACF of residuals ARIMA(3,0,3)")

```

# Q1 e

Obtain the residuals of the ARMA model estimated in item (e). Test for the presence of ARCH effects. Analyze the time series properties of the squared residuals and use that information to propose ARMA-GARCH models for the log returns. Justify in detail your options.

**H0**: no residual autocorrelation through tested lags

**H1**: there is the residual autocorrelation through tested lags

```{r}
arch_test_and_propose_models <- function(residuals) {
  ljung_box_test <- Box.test(residuals^2, lag = 10, type = "Ljung-Box")
  print(ljung_box_test)
  
  #acf(residuals^2, main = "ACF of Squared Residuals")
  #pacf(residuals^2, main = "PACF of Squared Residuals")
  
  # Choosing the best GARCH model based on AIC
  best_aic <- 6000000
  best_order <- NULL
  best_model <- NULL
  
  for (p in 0:5) {
    for (q in 0:5) {
      if (p == 0 && q == 0) next
      
      spec <- ugarchspec(
        mean.model = list(armaOrder = c(0, 1)),
        variance.model = list(model = "sGARCH", garchOrder = c(p, q)),
        distribution.model = "norm"
      )
      
      fit <- ugarchfit(spec = spec, data = residuals,, optim.method = "nlminb")
 
      aic <- infocriteria(fit)[1]
      if (aic < best_aic) {
        best_aic <- aic
        best_order <- c(p, q)
        best_model <- fit
      }
    }
  }
  
  cat("Best GARCH Model Order (p,q):", best_order, "\n")
  cat("Best AIC:", best_aic, "\n")
  print(best_model)
  
  return(best_model)
}
```

### Ljung box test and ARMA GARCH model Microsoft

```{r}
msft_residuals <-residuals(msft_arma_model)
msft_arma_garch_model <- arch_test_and_propose_models(data_ts$log_rtn)
```

### Squared residuals Microsoft

```{r}
squared_residuals <- msft_residuals^2
ggplot() +
  geom_line(aes(x = msft_residuals, y = squared_residuals)) +
  labs(title = "Squared Residuals",
       x = "Date",
       y = "Squared Residuals") +
  theme_minimal()
```

### Ljung box test and ARMA GARCH model Visa

```{r}
visa_residuals <- residuals(visa_arma_model)

Box.test(visa_residuals^2, lag = 10, type = "Ljung-Box")

visa_arma_garch_model <- arch_test_and_propose_models(visa_residuals)
```

### Squared residuals Visa

```{r}
squared_residuals <- visa_residuals^2
  ggplot() +
    geom_line(aes(x = visa_residuals, y = squared_residuals)) +
    labs(title = "Squared Residuals",
         x = "Date",
         y = "Squared Residuals") +
    theme_minimal()
```

# Q1 f

Evaluate the adequacy of the proposed models with the appropriate diagnostic checking procedures. Select the ARMA-GARCH model that best fits the dynamic properties of the log returns. Justify your choice.

```{r}
spec_msft <- ugarchspec(
  mean.model = list(armaOrder = c(0, 1)),
  variance.model = list(model = "sGARCH", garchOrder = c(2, 2)),
  distribution.model = "norm"
)

fit_msft <- ugarchfit(spec = spec_msft, data = data_ts$log_rtn)

# m_res <- residuals(fit_msft)
# Box.test(m_res, lag = 10, type = "Ljung-Box")
# Box.test(m_res^2, lag = 10, type = "Ljung-Box")
# describe(m_res)
m_stand_res <- fit_msft@fit$z
m_stand_res_squared <- fit_msft@fit$z^2
Box.test(m_stand_res, lag = 10, type = "Ljung-Box")
Box.test(m_stand_res_squared, lag = 10, type = "Ljung-Box")
describe(m_stand_res)


spec_visa <- ugarchspec(
  mean.model = list(armaOrder = c(3, 3)),
  variance.model = list(model = "sGARCH", garchOrder = c(2, 3)),
  distribution.model = "norm"
)

fit_visa <- ugarchfit(spec = spec_visa, data = data_ts_visa$log_rtn)

v_stand_res <- fit_visa@fit$z
v_stand_res_squared <- fit_visa@fit$z^2
Box.test(v_stand_res, lag = 10, type = "Ljung-Box")
Box.test(v_stand_res_squared, lag = 10, type = "Ljung-Box")
describe(v_stand_res)
```


# Q1 g

Write explicitly the estimated equation in the standard mathematical ARMA- GARCH form. Approximate your results to 3 decimal places.

[done exlusively in the report]


# Q1 h

Redo the previous 3 items on the basis of the t-distribution for the error term.
Do you find a better goodness-of-fit than in item (e)?

```{r}
arch_test_and_propose_models_tstudent <- function(residuals) {
  ljung_box_test <- Box.test(residuals^2, lag = 10, type = "Ljung-Box")
  print(ljung_box_test)
  
  #acf(residuals^2, main = "ACF of Squared Residuals")
  #pacf(residuals^2, main = "PACF of Squared Residuals")
  
  # Choosing the best GARCH model based on AIC
  best_aic <- 6000000
  best_order <- NULL
  best_model <- NULL
  
  for (p in 0:5) {
    for (q in 0:5) {
      if (p == 0 && q == 0) next
      tryCatch({
      spec <- ugarchspec(
        mean.model = list(armaOrder = c(3, 3)),
        variance.model = list(model = "sGARCH", garchOrder = c(p, q)),
        distribution.model = "std"
      )
      
      fit <- ugarchfit(spec = spec, data = residuals,)
 
      aic <- infocriteria(fit)[1]
      if (aic < best_aic) {
        best_aic <- aic
        best_order <- c(p, q)
        best_model <- fit
      }
      },
      warning = function(cond){NULL}
      )
    }
  }
  
  cat("Best GARCH Model Order (p,q):", best_order, "\n")
  cat("Best AIC:", best_aic, "\n")
  print(best_model)
  
  return(best_model)
}
```

### Ljung box test and ARMA GARCH model Microsoft:
```{r}
msft_residuals <- residuals(msft_arma_model)
msft_arma_garch_model <- arch_test_and_propose_models_tstudent(data_ts$log_rtn)

spec_msft_std <- ugarchspec(
  mean.model = list(armaOrder = c(0, 1)),
  variance.model = list(model = "sGARCH", garchOrder = c(1, 1)),
  distribution.model = "std"
)

fit_msft_std <- ugarchfit(spec = spec_msft_std, data = data_ts$log_rtn)

m_stand_res_std <- fit_msft_std@fit$z
m_stand_res_std_squared <- fit_msft_std@fit$z^2
Box.test(m_stand_res_std, lag = 10, type = "Ljung-Box")
Box.test(m_stand_res_std_squared, lag = 10, type = "Ljung-Box")
describe(m_stand_res_std)
```

### Ljung box test and ARMA GARCH model Visa:
```{r}
visa_residuals <- residuals(visa_arma_model)
visa_arma_garch_model <- arch_test_and_propose_models_tstudent(data_ts_visa$log_rtn)

spec_visa_std <- ugarchspec(
  mean.model = list(armaOrder = c(3, 3)),
  variance.model = list(model = "sGARCH", garchOrder = c(1, 1)),
  distribution.model = "std"
)

fit_visa_std <- ugarchfit(spec = spec_visa_std, data = data_ts_visa$log_rtn)

v_stand_res_std <- fit_visa_std@fit$z
v_stand_res_std_squared <- fit_visa_std@fit$z^2
Box.test(v_stand_res_std, lag = 10, type = "Ljung-Box")
Box.test(v_stand_res_std_squared, lag = 10, type = "Ljung-Box")
describe(v_stand_res_std)
```

# Q1 i

```{r}
# MICROSOFT

# Specify the start and end indexes for the estimation and forecast periods
start_estimation <- 1  # Start index of the estimation period
end_estimation <- nrow(data_ts) - 200  # End index of the estimation period
start_forecast <- end_estimation + 1  # Start index of the forecast period (last 10 records)
end_forecast <- nrow(data_ts)  # End index of the forecast period

# Choose the sample for the estimation period (Microsoft)
estimation_sample_msft <- window(data_ts$log_rtn, start = start_estimation, end = end_estimation)

# Choose the sample for the forecast period (Microsoft)
forecast_sample_msft <- window(data_ts$log_rtn, start = start_forecast, end = end_forecast)

# Microsoft: MA(1)-GARCH(2, 2), normal: dynamic forecasts
forecast_model_msft <- ugarchspec(
  mean.model = list(armaOrder = c(0, 1)),
  variance.model = list(model = "sGARCH", garchOrder = c(2, 2)),
  distribution.model = "norm"
)
fitted_model_msft <- ugarchfit(spec = forecast_model_msft, data = estimation_sample_msft)
forecast_results_msft <- ugarchforecast(fitted_model_msft, n.ahead = length(forecast_sample_msft))
print(forecast_results_msft)

# Microsoft: MA(1)-GARCH(2, 2), normal: static forecasts
m_sigma_static_forc <- c()
m_rtn_static_forc <- c()
.init = start_forecast
for (i in .init:end_forecast){
  fit <- rugarch::ugarchfit(data = data_ts$log_rtn[1:i], spec = forecast_model_msft)
  forc <- rugarch::ugarchforecast(fit,n.ahead = 1)
  m_sigma_static_forc[i-.init+1] <- forc@forecast$sigmaFor
  m_rtn_static_forc[i-.init+1] <- forc@forecast$seriesFor
}

# Microsoft: MA(1)-GARCH(1, 1), t-student: dynamic forecasts
forecast_model_msft_std <- ugarchspec(
  mean.model = list(armaOrder = c(0, 1)),
  variance.model = list(model = "sGARCH", garchOrder = c(1, 1)),
  distribution.model = "std"
)
fitted_model_msft_std <- ugarchfit(spec = forecast_model_msft_std, data = estimation_sample_msft)
forecast_results_msft_std <- ugarchforecast(fitted_model_msft_std, n.ahead = length(forecast_sample_msft))
print(forecast_results_msft_std)

# Microsoft: MA(1)-GARCH(1, 1), t-student: static forecasts
m_sigma_static_forc_std <- c()
m_rtn_static_forc_std <- c()
.init = start_forecast
for (i in .init:end_forecast){
  fit <- rugarch::ugarchfit(data = data_ts$log_rtn[1:i], spec = forecast_model_msft_std)
  forc <- rugarch::ugarchforecast(fit,n.ahead = 1)
  m_sigma_static_forc_std[i-.init+1] <- forc@forecast$sigmaFor
  m_rtn_static_forc_std[i-.init+1] <- forc@forecast$seriesFor
}

# Plot the sigma forecasts
data_tibble <- tibble(index = 1:(length(m_sigma_static_forc_std)),
       abs_rtns=abs(data_ts$log_rtn[start_forecast:end_forecast]),
       dynamic_normal_sigma=forecast_results_msft@forecast$sigmaFor,
       static_normal_sigma=m_sigma_static_forc,
       dynamic_std_sigma=forecast_results_msft_std@forecast$sigmaFor,
       static_std_sigma=m_sigma_static_forc_std)
# Convert to tsibble
data_tsibble <- data_tibble %>%
  as_tsibble(index = index)
# Reshape to long format
data_long <- data_tsibble %>%
  pivot_longer(cols = -index, names_to = "series", values_to = "value")
# Plot the data on the same axes
ggplot(data_long, aes(x = index, y = value, color = series)) +
  geom_line() +
  labs(title = "Time Series Plot",
       x = "Index",
       y = "Value",
       color = "Series") +
  theme_minimal()

# Plot the return forecasts
data_tibble <- tibble(index = 1:(length(m_sigma_static_forc_std)),
       abs_rtns=data_ts$log_rtn[start_forecast:end_forecast],
       dynamic_normal_rtn=forecast_results_msft@forecast$seriesFor,
       static_normal_rtn=m_rtn_static_forc,
       dynamic_std_rtn=forecast_results_msft_std@forecast$seriesFor,
       static_std_rtn=m_rtn_static_forc_std)
# Convert to tsibble
data_tsibble <- data_tibble %>%
  as_tsibble(index = index)
# Reshape to long format
data_long <- data_tsibble %>%
  pivot_longer(cols = -index, names_to = "series", values_to = "value")
# Plot the data on the same axes
ggplot(data_long, aes(x = index, y = value, color = series)) +
  geom_line() +
  labs(title = "Time Series Plot",
       x = "Index",
       y = "Value",
       color = "Series") +
  theme_minimal()


# VISA

# Choose the sample for the estimation period (Visa)
estimation_sample_visa <- window(data_ts_visa$log_rtn, start = start_estimation, end = end_estimation)

# Choose the sample for the forecast period (Visa)
forecast_sample_visa <- window(data_ts_visa$log_rtn, start = start_forecast, end = end_forecast)

# Visa: ARMA(3,3)-GARCH(2, 3), normal: dynamic forecasts
forecast_model_visa <- ugarchspec(
  mean.model = list(armaOrder = c(3, 3)),
  variance.model = list(model = "sGARCH", garchOrder = c(2, 3)),
  distribution.model = "norm"
)
fitted_model_visa <- ugarchfit(spec = forecast_model_visa, data = estimation_sample_visa)
forecast_results_visa <- ugarchforecast(fitted_model_visa, n.ahead = length(forecast_sample_visa))
print(forecast_results_visa)

# Visa: ARMA(3,3)-GARCH(2, 3), normal: static forecasts
v_sigma_static_forc <- c()
v_rtn_static_forc <- c()
.init = start_forecast
for (i in .init:end_forecast){
  tryCatch(
  {
    fit <- rugarch::ugarchfit(data = data_ts_visa$log_rtn[1:i], spec = forecast_model_visa)
    forc <- rugarch::ugarchforecast(fit,n.ahead = 1)
    v_sigma_static_forc[i-.init+1] <- forc@forecast$sigmaFor
    v_rtn_static_forc[i-.init+1] <- forc@forecast$seriesFor
  },
  error = function(cond){}
  )
}

# Visa: ARMA(3,3)-GARCH(1, 1), t-student: dynamic forecasts
forecast_model_visa_std <- ugarchspec(
  mean.model = list(armaOrder = c(3, 3)),
  variance.model = list(model = "sGARCH", garchOrder = c(1, 1)),
  distribution.model = "std"
)
fitted_model_visa_std <- ugarchfit(spec = forecast_model_visa_std, data = estimation_sample_visa)
forecast_results_visa_std <- ugarchforecast(fitted_model_visa_std, n.ahead = length(forecast_sample_visa))
print(forecast_results_visa_std)

# Visa: MA(1)-GARCH(1, 1), t-student: static forecasts
v_sigma_static_forc_std <- c()
v_rtn_static_forc_std <- c()
.init = start_forecast
for (i in .init:end_forecast){
  tryCatch(
  {
    fit <- rugarch::ugarchfit(data = data_ts_visa$log_rtn[1:i], spec = forecast_model_visa_std)
    forc <- rugarch::ugarchforecast(fit,n.ahead = 1)
    v_sigma_static_forc_std[i-.init+1] <- forc@forecast$sigmaFor
    v_rtn_static_forc_std[i-.init+1] <- forc@forecast$seriesFor
  },
  error = function(cond){}
  )
}

# Plot the sigma forecasts
data_tibble <- tibble(index = 1:(length(v_sigma_static_forc_std)),
        abs_rtns=abs(data_ts_visa$log_rtn[start_forecast:end_forecast]),
       dynamic_normal_sigma=forecast_results_visa@forecast$sigmaFor,
       static_normal_sigma=v_sigma_static_forc,
       dynamic_std_sigma=forecast_results_visa_std@forecast$sigmaFor,
       static_std_sigma=v_sigma_static_forc_std)
# Convert to tsibble
data_tsibble <- data_tibble %>%
  as_tsibble(index = index)
# Reshape to long format
data_long <- data_tsibble %>%
  pivot_longer(cols = -index, names_to = "series", values_to = "value")
# Plot the data on the same axes
ggplot(data_long, aes(x = index, y = value, color = series)) +
  geom_line() +
  labs(title = "Time Series Plot",
       x = "Index",
       y = "Value",
       color = "Series") +
  theme_minimal()

# Plot the return forecasts
data_tibble <- tibble(index = 1:(length(v_sigma_static_forc_std)),
       abs_rtns=data_ts_visa$log_rtn[start_forecast:end_forecast],
       dynamic_normal_rtn=forecast_results_visa@forecast$seriesFor,
       static_normal_rtn=v_rtn_static_forc,
       dynamic_std_rtn=forecast_results_visa_std@forecast$seriesFor,
       static_std_rtn=m_rtn_static_forc_std)
# Convert to tsibble
data_tsibble <- data_tibble %>%
  as_tsibble(index = index)
# Reshape to long format
data_long <- data_tsibble %>%
  pivot_longer(cols = -index, names_to = "series", values_to = "value")
# Plot the data on the same axes
ggplot(data_long, aes(x = index, y = value, color = series)) +
  geom_line() +
  labs(title = "Time Series Plot",
       x = "Index",
       y = "Value",
       color = "Series") +
  theme_minimal()


```

# Q1 j

```{r}
# MICROSOFT

# Microsoft: MA(1)-GARCH(2, 2), normal: dynamic forecasts
forecast_model_msft <- ugarchspec(
  mean.model = list(armaOrder = c(0, 1)),
  variance.model = list(model = "sGARCH", garchOrder = c(2, 2)),
  distribution.model = "norm"
)
fitted_model_msft <- ugarchfit(spec = forecast_model_msft, data = data_ts$log_rtn)
forecast_results_msft <- ugarchforecast(fitted_model_msft, n.ahead = 2)
print(forecast_results_msft)

# Microsoft: MA(1)-GARCH(1, 1), t-student: dynamic forecasts
forecast_model_msft_std <- ugarchspec(
  mean.model = list(armaOrder = c(0, 1)),
  variance.model = list(model = "sGARCH", garchOrder = c(1, 1)),
  distribution.model = "std"
)
fitted_model_msft_std <- ugarchfit(spec = forecast_model_msft_std, data = data_ts$log_rtn)
forecast_results_msft_std <- ugarchforecast(fitted_model_msft_std, n.ahead = 2)
print(forecast_results_msft_std)
```

# Q1 k

```{r}
# Microsoft leverage effects
data_ts %>% as_tibble() %>%
  summarise(corr = cor(log_rtn^2, lag(log_rtn), use='complete.obs'))

# Visa leverage effects
data_ts_visa %>% as_tibble() %>%
  summarise(corr = cor(log_rtn^2, lag(log_rtn), use='complete.obs'))

# Microsoft risk premium
garchm_spec <-  rugarch::ugarchspec(variance.model=list(model="sGARCH",
                                                 garchOrder=c(2,2)),
                             mean.model=list(armaOrder=c(0,1),
                                             include.mean=TRUE,
                                             archm=TRUE),
                             distribution.model = "norm")
garchm_msft <- rugarch::ugarchfit(data = data_ts$log_rtn, spec = garchm_spec)


# Visa risk premium
garchm_spec <-  rugarch::ugarchspec(variance.model=list(model="sGARCH",
                                                 garchOrder=c(2,3)),
                             mean.model=list(armaOrder=c(3,3),
                                             include.mean=TRUE,
                                             archm=TRUE),
                             distribution.model = "norm")
rugarch::ugarchfit(data = data_ts_visa$log_rtn, spec = garchm_spec)
```